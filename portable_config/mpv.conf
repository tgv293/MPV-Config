# ===================================================================
# CONFIG DUNG HỢP (FirefoxTweakVN + Tuilakhanh + Hongyue)
# Yêu cầu: Đã có file profiles.conf (từ bước trước)
# ===================================================================

# Load các profile bên ngoài (HD, SD, PiP, v.v...)
include="~~/profiles.conf"

# ===================================================================
# GENERAL SETTINGS
# ===================================================================
# Kích hoạt Profile Cân Bằng làm mặc định
profile=Balanced

#log-file="D:/mpv/mpv_debug.log"
# Giữ cửa sổ mở sau khi hết video
keep-open=yes
# Tạo cửa sổ ngay lập tức
force-window=immediate
# Không tự focus khi mở (tránh chiếm chuột)
focus-on=open
# Kích thước mặc định khi mở
autofit=75%x75%
# Lưu vị trí xem khi thoát (Bỏ comment nếu muốn dùng)
#save-position-on-quit=yes
# Tự động lưu vị trí và sub
watch-later-options=start,sid

# PiP setting (Góc dưới phải)
geometry=25%x25%-10-10 
ontop

# Load playlist không an toàn (cần thiết cho một số web)
load-unsafe-playlists=yes
# Fake User Agent để tránh bị chặn bởi server
user-agent='Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/144.0.7559.59 Safari/537.36'

# ===================================================================
# VIDEO & RENDERER (Core)
# ===================================================================
# Sử dụng driver mới nhất gpu-next (libplacebo)
vo=gpu-next
# Giải mã phần cứng
hwdec=d3d11va

# API đồ họa: D3D11 ổn định nhất trên Windows.
# Nếu dùng Linux hoặc muốn thử nghiệm mới nhất thì đổi thành 'vulkan'
gpu-api=d3d11
# gpu-api=vulkan 
# vulkan-async-compute=yes
# vulkan-async-transfer=yes
# vulkan-queue-count=1

# Cài đặt Dither (giảm noise/băng màu)
dither-depth=auto
dither-size-fruit=6
dither=fruit
temporal-dither=yes

# Khử răng cưa (Tắt để tăng hiệu năng, bật bằng phím tắt khi cần)
deinterlace=no

# Tone mapping cho HDR
tone-mapping=bt.2446a
video-output-levels=full

# ===================================================================
# OSC & OSD (Giao diện)
# ===================================================================
# Tắt giao diện mặc định để dùng UOSC (cần cài script uosc)
osc=no
osd-bar=no
border=no

# Ẩn chuột
cursor-autohide=100
cursor-autohide-fs-only=yes

# Font chữ thông báo trên màn hình
osd-font="Noto Sans ExtraBold"
osd-font-size=36
osd-bold=yes
osd-duration=1000
osd-shadow-offset=0.75
osd-outline-size=1.5
msg-color=yes
msg-module=yes

# ===================================================================
# AUDIO
# ===================================================================
# Âm lượng mặc định
volume=100
# Cho phép âm lượng lên 200%
volume-max=200
# Chỉnh pitch âm thanh khi tua nhanh để không bị méo tiếng
audio-pitch-correction=yes
# Tự load file audio cùng tên
audio-file-auto=fuzzy

# Ưu tiên ngôn ngữ âm thanh (Nhật -> Việt -> Anh)
alang=ja,jp,jpn,vi,vie,en,eng

# ===================================================================
# SUBTITLES (Phụ đề)
# ===================================================================
# Ưu tiên phụ đề (Việt -> Anh -> Nhật)
slang=vi,vie,en,eng,jp,jpn

# Tự động tìm và load sub
sub-auto=fuzzy
# Các thư mục tìm sub
sub-file-paths=ass;srt;sub;subs;subtitles;Subs

# Fix lỗi timing sub trong file MKV
demuxer-mkv-subtitle-preroll=yes
sub-fix-timing=no

# --- Style cho phụ đề dạng text (SRT, VTT) ---
# Dùng font Netflix Sans (nếu có) hoặc Open Sans
sub-font="Noto Sans ExtraBold"
sub-font-size=40
sub-color='#FFFFFFFF'
sub-border-color="#FF000000"
sub-border-size=2.0
sub-shadow-color=0.0/0.0/0.0/0.70
sub-shadow-offset=0.75
sub-bold=yes
sub-blur=0.3
sub-use-margins=no
# Scale sub ASS theo video hay theo cửa sổ (no = chuẩn hơn)
sub-ass-scale-with-window=no

# ===================================================================
# CACHE & NETWORK (Tối ưu bởi FirefoxTweakVN + Hongyue)
# ===================================================================
cache=auto
# Giữ cache khi pause (tốt cho mạng chậm)
cache-pause=no
# Bật cache trên ổ cứng nếu RAM ít (SSD thì thoải mái, HDD thì cân nhắc)
cache-on-disk=no  
# 500MB Cache RAM (Cân bằng)
demuxer-max-bytes=500MiB
demuxer-max-back-bytes=250MiB
# Thời gian đọc trước
demuxer-readahead-secs=300
# Thread riêng cho demuxer để mượt hơn
demuxer-thread=yes

# Tối ưu kết nối mạng
network-timeout=100
stream-lavf-o-append=reconnect_on_http_error=4xx,5xx
stream-lavf-o-append=reconnect_delay_max=30
stream-lavf-o-append=reconnect_streamed=yes
hls-bitrate=max

# ===================================================================
# YTDL (CODEC LOGIC & OPTIMIZATION)
# ===================================================================

# --- LOGIC CHỌN CODEC (Món ăn siêu cay - Phiên bản GPU "Gánh Team") ---
# Ưu tiên 1: Luôn chọn VP9 (vp09) vì card bạn hỗ trợ 8K bằng phần cứng (mát máy nhất).
# Ưu tiên 2: Dùng AVC1 (h264) cho các độ phân giải thấp hoặc khi không có VP9.
# Loại trừ: Tuyệt đối né AV1 (av01) để tránh CPU bị quá tải bởi libdav1d.
# Cuối cùng: Lấy bản tốt nhất miễn là không phải AV1.
ytdl-format="bestvideo[vcodec~='^vp9|^hvc1|^hev1']+bestaudio/bestvideo[vcodec^=avc1]+bestaudio/bestvideo+bestaudio/best"

# --- TỐI ƯU KẾT NỐI (Tăng tốc mở video) ---
# Loại bỏ các định dạng không cần thiết để check nhanh hơn
script-opts=ytdl_hook-try_ytdl_first=yes,ytdl_hook-exclude="%.webm$|%.ts$|%.mp3$|%.m3u8$|%.m3u$|%.mkv$|%.mp4$|%.VOB$|%.wmv$|%.ogg$|%.mpd$|%.mov$|%.webm$|%.webp$|%.avi$|%.flv$|%.swf$|%.f4v$"

# Các tùy chọn Raw (Bypass throttling & Full Metadata)
ytdl-raw-options-append=extractor-args=youtube:player-client=default,ios,-android_sdkless;formats=missing_pot
ytdl-raw-options-append=no-check-certificates=
ytdl-raw-options-append=yes-playlist=

# Chặn tải bình luận rác vào file metadata
ytdl-raw-options-append=no-write-comments=

# Tải sub và Metadata đầy đủ
ytdl-raw-options-append=sub-langs=en,en-US,eng,vi,vi-VN,vie,ja,ja-JP,jap,live_chat
ytdl-raw-options-append=write-sub=
ytdl-raw-options-append=write-auto-sub=
ytdl-raw-options-append=add-metadata=
ytdl-raw-options-append=audio-multistreams=
ytdl-raw-options-append=video-multistreams=

# ===================================================================
# SCREENSHOT
# ===================================================================
screenshot-format=png
screenshot-high-bit-depth=yes
screenshot-tag-colorspace=yes
# Nén mức 4 (Nhanh hơn mức 6)
screenshot-png-compression=4
screenshot-dir="~/Pictures/mpv"
# Tên file ảnh chi tiết (Tên phim - Thời gian)
screenshot-template="%{?demuxer-via-network==yes:${media-title}%{?demuxer-via-network==yes:_${filename/no-ext}%{!demuxer-via-network==yes:${filename}-%wH.%wM.%wS.%wT-#%#00n"

# ===================================================================
# ADVANCED FEATURES (Deband, Interpolation)
# ===================================================================
# Debanding (Khử nhiễu màu): Tắt mặc định, bật khi video bị vỡ hạt
deband=no
deband-iterations=4
deband-threshold=164
deband-range=6
deband-grain=5

# Interpolation (Làm mượt chuyển động):
# Profile Balanced trong profiles.conf đã setup phần này.
# Setting dưới đây là fallback.
tscale=oversample
# tscale=sphinx (Nặng hơn nhưng đẹp hơn, dùng cho máy mạnh)
tscale-blur=0.6991556596428412
tscale-radius=1.05
tscale-clamp=0.0